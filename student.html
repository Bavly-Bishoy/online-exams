<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>امتحان — صفحة الطالب</title>
<style>
:root{
--blue:#0d6efd; --gray:#6b7280; --bg:#ffffff; --card:#f8fafc; --text:#0f172a;
--dark-bg:#0f1724; --dark-card:#111827; --dark-text:#f8fafc;
}
body{font-family:"Cairo",sans-serif;margin:0;padding:20px;background:var(--bg);color:var(--text);transition:all .25s}
body.dark{background:var(--dark-bg);color:var(--dark-text)}
.container{max-width:900px;margin:0 auto}
header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;color:var(--blue)}
.card{background:var(--card);border-radius:12px;padding:18px;margin-top:18px;box-shadow:0 6px 20px rgba(15,23,42,0.06)}
body.dark .card{background:var(--dark-card);box-shadow:none}
label{display:block;font-weight:700;margin:8px 0}
input[type=text], input[type=email], select, button, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:15px;box-sizing:border-box}
body.dark input, body.dark textarea, body.dark select{background:#071022;color:var(--dark-text);border:1px solid #1f2937}
.row{display:flex;gap:10px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{background:var(--blue);color:white;border:none;padding:10px 18px;border-radius:10px;cursor:pointer}
.btn.ghost{background:transparent;color:var(--blue);border:1px solid var(--blue)}
.q-card{background:var(--bg);border-radius:10px;padding:14px;margin:12px 0;border:1px solid #e6eefb}
body.dark .q-card{background:#0b1220;border:1px solid #1f2937}
.options{margin-top:8px;display:flex;flex-direction:column;gap:8px}
.opt{display:flex;gap:10px;align-items:center}
.timer{font-weight:700;color:var(--blue)}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
<header>
<h1 id="title">امتحان</h1>
<div class="small">نظام امتحانات — نسخة تجريبية</div>
</header>

<!-- إعداد الطالب -->
<div id="startCard" class="card">
<label>الاسم الكامل</label>
<input id="studentName" type="text" placeholder="اكتب اسمك الكامل">

<label>البريد الإلكتروني</label>
<input id="studentEmail" type="email" placeholder="example@mail.com">

<label>اختيار الثيم</label>
<div class="row">
<select id="themeSelect">
<option value="light">فاتح</option>
<option value="dark">غامق</option>
</select>
<div>
<button class="btn" id="startBtn">ابدأ الامتحان</button>
</div>
</div>
<div class="small">اختيار الثيم سيُحفظ في جهازك وسيُستخدم تلقائياً لاحقاً.</div>
</div>

<!-- منطقة الامتحان -->
<div id="examArea" class="card hidden">
<div class="row" style="align-items:center;justify-content:space-between">
<div>
<strong id="examTitle">عنوان الامتحان</strong><br>
<span class="small" id="examLangLabel"></span>
</div>
<div style="text-align:right">
<div>الوقت المتبقي: <span class="timer" id="timer">00:00</span></div>
<div class="small">السؤال <span id="currentIndex">1</span> / <span id="totalQ">0</span></div>
</div>
</div>

<div id="questionBox" class="q-card"></div>

<div class="controls">
<button class="btn ghost" id="prevBtn">السابق</button>
<button class="btn" id="nextBtn">التالي</button>
<button class="btn" id="finishBtn">إنهاء الامتحان</button>
</div>
<div id="notice" class="small" style="margin-top:10px"></div>
</div>

<!-- النتائج -->
<div id="resultCard" class="card hidden">
<h3>النتيجة</h3>
<div id="scoreSummary"></div>
<div id="detailedTable"></div>
</div>
</div>

<script>
let exam=null,questions=[],current=0,answers=[],timerInterval=null,remainingSeconds=0;
const params=new URLSearchParams(window.location.search);
const examFile=params.get('exam');

const themeSelect=document.getElementById('themeSelect');
function applyTheme(theme){
  if(theme==='dark'){document.body.classList.add('dark')}else{document.body.classList.remove('dark')}
  localStorage.setItem('exam_theme',theme);
}
themeSelect.value=localStorage.getItem('exam_theme')||'light';
applyTheme(themeSelect.value);
themeSelect.addEventListener('change',()=>applyTheme(themeSelect.value));

document.getElementById('startBtn').addEventListener('click',startClicked);
function startClicked(){
  const name=document.getElementById('studentName').value.trim();
  const email=document.getElementById('studentEmail').value.trim();
  if(!name||!email)return alert('اكتب الاسم والإيميل قبل البدء');
  sessionStorage.setItem('student_name',name);
  sessionStorage.setItem('student_email',email);
  if(!exam){ if(!examFile)return alert('رابط الامتحان ناقص'); loadExamFile(examFile);}else{showExamArea();}
}

function loadExamFile(name){
  fetch(name).then(r=>r.json()).then(data=>{
    exam=data; questions=exam.questions||[];
    answers=questions.map((q,i)=>{
      const stored=JSON.parse(localStorage.getItem('exam_answer_'+i)||'null');
      return {type:q.type, answer:stored?.answer||null};
    });
    remainingSeconds=Number(localStorage.getItem('exam_time'))||((Number(exam.time)||10)*60);
    prepareExamUI();
  }).catch(err=>alert('خطأ في تحميل الامتحان: '+err.message));
}

function prepareExamUI(){
  document.getElementById('title').textContent=exam.examName||'امتحان';
  document.getElementById('examTitle').textContent=exam.examName||'امتحان';
  document.getElementById('examLangLabel').textContent=(exam.language==='ar')?'اللغة: العربية':'Language: English';
  document.getElementById('totalQ').textContent=questions.length;
  startTimer(); showExamArea();
}

function showExamArea(){document.getElementById('startCard').classList.add('hidden'); document.getElementById('examArea').classList.remove('hidden'); current=0; renderQuestion(); updateNavButtons();}

function startTimer(){
  updateTimerDisplay();
  if(timerInterval)clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    remainingSeconds--;
    localStorage.setItem('exam_time',remainingSeconds);
    if(remainingSeconds<=0){clearInterval(timerInterval);finishExam();}
    updateTimerDisplay();
  },1000);
}

function updateTimerDisplay(){
  const mm=String(Math.floor(remainingSeconds/60)).padStart(2,'0');
  const ss=String(remainingSeconds%60).padStart(2,'0');
  document.getElementById('timer').textContent=`${mm}:${ss}`;
}

function renderQuestion(){
  const q=questions[current];
  const box=document.getElementById('questionBox');
  document.getElementById('currentIndex').textContent=current+1;
  let html=`<div><strong>السؤال ${current+1}:</strong></div><div style="margin-top:8px">${escapeHtml(q.text||'')}</div>`;
  html+=`<div class="small" style="margin-top:8px">نوع السؤال: ${q.type}</div><div class="options">`;
  if(q.type==='mcq'){(q.choices||[]).forEach((c,i)=>{
    const id=`opt_${current}_${i}`;
    const checked=(answers[current].answer===c)?'checked':'';
    html+=`<label class="opt"><input type="radio" name="ans_${current}" id="${id}" ${checked} value="${escapeAttr(c)}"> <span>${escapeHtml(c)}</span></label>`;
  });}
  else if(q.type==='truefalse'){
    const opts=(exam.language==='ar')?[['true','صح'],['false','خطأ']]:[['true','True'],['false','False']];
    opts.forEach((p,i)=>{ const id=`tf_${current}_${i}`; const checked=(answers[current].answer===p[0])?'checked':''; html+=`<label class="opt"><input type="radio" name="ans_${current}" id="${id}" ${checked} value="${p[0]}"> <span>${p[1]}</span></label>`;});}
  else{ const val=answers[current].answer||''; html+=`<input type="text" id="textAns" value="${val}" placeholder="اكتب إجابتك هنا">`;}
  html+='</div>'; box.innerHTML=html;
  attachAnswerEvents();
}

function attachAnswerEvents(){
  const q=questions[current];
  if(q.type==='mcq'||q.type==='truefalse'){
    document.querySelectorAll('input[name="ans_'+current+'"]').forEach(el=>{
      el.addEventListener('change',()=>saveAnswer(el.value));
    });
  } else{
    document.getElementById('textAns').addEventListener('input',e=>saveAnswer(e.target.value));
  }
}

function saveAnswer(val){answers[current].answer=val; localStorage.setItem('exam_answer_'+current,JSON.stringify({answer:val}));}

document.getElementById('prevBtn').addEventListener('click',()=>{
  if(current>0){current--; renderQuestion(); updateNavButtons();}});
document.getElementById('nextBtn').addEventListener('click',()=>{
  if(current<questions.length-1){current++; renderQuestion(); updateNavButtons();}});

function updateNavButtons(){
  document.getElementById('prevBtn').disabled=(current===0);
  document.getElementById('nextBtn').disabled=(current===questions.length-1);
}

document.getElementById('finishBtn').addEventListener('click',finishExam);

function finishExam(){
  clearInterval(timerInterval);
  document.getElementById('examArea').classList.add('hidden');
  document.getElementById('resultCard').classList.remove('hidden');
  let correct=0;
  let html=`<p>عدد الأسئلة: ${questions.length}</p>`;
  questions.forEach((q,i)=>{
    const ans=answers[i].answer||'(لم يجب)';
    const cor=(q.type==='mcq'||q.type==='text')?q.answer:((q.answer===ans)?ans:null);
    if(cor===ans)correct++;
  });
  html+=`<p>الدرجات: ${correct} / ${questions.length}</p>`;
  document.getElementById('scoreSummary').innerHTML=html;
  let table='<table border="1" cellpadding="6" cellspacing="0"><tr><th>السؤال</th><th>إجابتك</th><th>الإجابة الصحيحة</th></tr>';
  questions.forEach((q,i)=>{
    const ans=answers[i].answer||'(لم يجب)';
    let correctAns=(q.type==='mcq'||q.type==='text')?q.answer:(q.answer);
    table+=`<tr><td>${escapeHtml(q.text)}</td><td>${escapeHtml(ans)}</td><td>${escapeHtml(correctAns)}</td></tr>`;
  });
  table+='</table>';
  document.getElementById('detailedTable').innerHTML=table;
  localStorage.removeItem('exam_time');
  questions.forEach((q,i)=>localStorage.removeItem('exam_answer_'+i));
}

function escapeHtml(text){return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
function escapeAttr(text){return text.replace(/"/g,'&quot;');}
</script>
</body>
</html>
